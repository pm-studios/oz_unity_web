<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>FUZE Avatar Web Player</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
    <style>
      body {
        margin: 0;
        padding: 0;
        background-color: #4A6B8A;
      }

      #unity-canvas {
        display: block;
        margin: 0 auto;
        background-color: #4A6B8A;
      }

      /* 디버그 패널 */
      #debug-panel {
        position: fixed;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.8);
        color: #0f0;
        padding: 10px;
        font-family: monospace;
        font-size: 11px;
        max-width: 300px;
        max-height: 400px;
        overflow-y: auto;
        z-index: 9999;
        border: 1px solid #0f0;
      }

      body.compact-mode {
        overflow: hidden;
      }

      body.compact-mode #unity-container {
        width: 100vw !important;
        height: 100vh !important;
        margin: 0 !important;
        padding: 0 !important;
      }

      body.compact-mode #unity-canvas {
        width: 100% !important;
        height: 100% !important;
        margin: 0 !important;
      }

      body.compact-mode .control-panel,
      body.compact-mode #unity-footer,
      body.compact-mode #unity-warning,
      body.compact-mode #debug-panel {
        display: none !important;
      }

      .control-panel {
        margin: 10px auto;
        max-width: 300px;
        text-align: center;
      }

      .input-group {
        margin: 10px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .input-group input {
        padding: 5px 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        font-size: 14px;
        width: 80px;
      }

      .control-button {
        padding: 6px 12px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 13px;
        transition: background-color 0.3s;
      }

      .control-button:hover {
        background-color: #45a049;
      }

      .control-button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }

      .toggle-button {
        background-color: #2196F3;
      }

      .toggle-button:hover {
        background-color: #1976D2;
      }

      .toggle-button.active {
        background-color: #FF5722;
      }

      .toggle-button.active:hover {
        background-color: #E64A19;
      }

      #unity-container {
        background-color: #4A6B8A;
      }

      #unity-loading-bar {
        top: 30%;
      }

      #unity-loading-bar::before {
        content: "Getting avatar ready...";
        display: block;
        color: white;
        font-size: 16px;
        margin-bottom: 10px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <!-- 디버그 패널 -->
    <div id="debug-panel"></div>

    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width=350 height=470 tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"> </div>
      <div id="unity-footer">
        <div id="unity-fullscreen-button"></div>
      </div>
      
      <div class="control-panel">
        <div class="input-group">
          <input type="number" id="user-id-input" value="5681" min="1" max="999999" placeholder="User ID">
          <button class="control-button" onclick="setUserId()">Set User ID</button>
          <button id="setmine-button" class="control-button toggle-button" onclick="toggleSetMine()">SetMine: true</button>
        </div>
      </div>
    </div>

    <script>
      // ========== 디버그 시스템 ==========
      var debugPanel = document.getElementById('debug-panel');
      var debugLogs = [];
      
      function debugLog(message) {
        var timestamp = new Date().toLocaleTimeString();
        var logMessage = `[${timestamp}] ${message}`;
        
        console.log(logMessage);
        debugLogs.push(logMessage);
        
        if (debugLogs.length > 50) {
          debugLogs.shift();
        }
        
        debugPanel.innerHTML = debugLogs.map(log => 
          `<div style="margin: 2px 0; ${log.includes('MALI') || log.includes('ERROR') ? 'color: #f00; font-weight: bold;' : ''}">${log}</div>`
        ).join('');
        
        debugPanel.scrollTop = debugPanel.scrollHeight;
      }

      // ========== GPU 정보 감지 ==========
      var isMaliGPU = false;
      var gpuInfo = { vendor: 'unknown', renderer: 'unknown' };

      function detectGPU() {
        try {
          var testCanvas = document.createElement('canvas');
          var gl = testCanvas.getContext('webgl2') || testCanvas.getContext('webgl');
          
          if (gl) {
            var debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
            if (debugInfo) {
              gpuInfo.vendor = gl.getParameter(debugInfo.UNMASKED_VENDOR_WEBGL);
              gpuInfo.renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
              
              isMaliGPU = gpuInfo.renderer.toLowerCase().includes('mali');
              
              debugLog(`GPU: ${gpuInfo.renderer}`);
              debugLog(`Vendor: ${gpuInfo.vendor}`);
              
              if (isMaliGPU) {
                debugLog('===== MALI GPU 감지됨 =====');
              }
            }
          }
        } catch (e) {
          debugLog(`GPU 감지 실패: ${e.message}`);
        }
      }

      // ========== Canvas 상태 로깅 ==========
      function logCanvasState(label) {
        debugLog(`----- ${label} -----`);
        debugLog(`Canvas.width: ${canvas.width}, height: ${canvas.height}`);
        debugLog(`Canvas.style: ${canvas.style.width} x ${canvas.style.height}`);
        debugLog(`Canvas.offset: ${canvas.offsetWidth} x ${canvas.offsetHeight}`);
        debugLog(`Canvas.display: ${getComputedStyle(canvas).display}`);
        debugLog(`Canvas.visibility: ${getComputedStyle(canvas).visibility}`);
      }

      // ========== 기존 변수들 ==========
      var urlParams = new URLSearchParams(window.location.search);
      var isCompactMode = urlParams.has('mode') && urlParams.get('mode') === 'compact';
      var urlUserId = urlParams.has('userId') ? urlParams.get('userId') : null;
      var isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

      if (isCompactMode || isMobile) {
        document.body.classList.add('compact-mode');
        debugLog('컴팩트 모드 활성화');
      }

      if (urlUserId) {
        debugLog(`URL User ID: ${urlUserId}`);
      }

      var canvas = document.querySelector("#unity-canvas");
      var unityInstance = null;
      var isLoaded = false;
      var isMineActive = true;

      // GPU 감지 실행
      detectGPU();

      // ========== Unity 사이즈 변경 함수 ==========
      function changeUnitySize(width, height) {
        if (isCompactMode || isMobile) {
          debugLog('컴팩트 모드에서는 사이즈 변경 안함');
          return;
        }
        
        debugLog(`Unity 사이즈 변경: ${width}x${height}`);
        
        canvas.style.width = width + "px";
        canvas.style.height = height + "px";
        canvas.width = width;
        canvas.height = height;
        
        logCanvasState('사이즈 변경 후');
      }

      // ========== Unity 메시지 핸들러 ==========
      function handleStateChanged(status) {
        debugLog(`Unity 상태 변경: ${status}`);

        switch (status) {
          case "EnterFullscreen":
            changeUnitySize(988, 698);
            break;

          case "LeaveFullscreen":
            changeUnitySize(350, 470);
            break;
        }
      }

      function handleChangedAvatar(url) {
        debugLog(`Avatar 변경: ${url}`);
      }

      // ========== User ID 설정 ==========
      function setUserId() {
        if (!isLoaded || !unityInstance) {
          debugLog('Unity 미로드 - User ID 설정 불가');
          alert("Unity가 아직 로드되지 않았습니다.");
          return;
        }

        var userIdInput = document.getElementById("user-id-input");
        var userId = parseInt(userIdInput.value);

        if (isNaN(userId) || userId < 1) {
          debugLog('잘못된 User ID 입력');
          alert("유효한 User ID를 입력해주세요");
          return;
        }

        debugLog(`User ID 설정: ${userId}`);
        unityInstance.SendMessage("System", "LoadMineAvatar_ForDev", userId);
        
        var button = event.target;
        var originalText = button.textContent;
        button.textContent = "설정됨!";
        button.disabled = true;
        
        setTimeout(() => {
          button.textContent = originalText;
          button.disabled = false;
        }, 1000);
      }

      // ========== SetMine 토글 ==========
      function toggleSetMine() {
        if (!isLoaded || !unityInstance) {
          debugLog('Unity 미로드 - SetMine 토글 불가');
          alert("Unity가 아직 로드되지 않았습니다.");
          return;
        }

        isMineActive = !isMineActive;
        
        var button = document.getElementById("setmine-button");
        button.textContent = `SetMine: ${isMineActive}`;
        
        if (isMineActive) {
          button.classList.remove("active");
        } else {
          button.classList.add("active");
        }

        var mineValue = isMineActive ? 1 : 0;
        debugLog(`SetMine 토글: ${mineValue}`);
        unityInstance.SendMessage("System", "SetMine", mineValue);
      }

      // ========== Enter 키 이벤트 ==========
      document.addEventListener('DOMContentLoaded', function() {
        var userIdInput = document.getElementById("user-id-input");
        
        if (urlUserId) {
          userIdInput.value = urlUserId;
        }
        
        userIdInput.addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
            setUserId();
          }
        });
      });

      // ========== Unity 배너 함수 ==========
      function unityShowBanner(msg, type) {
        debugLog(`Unity 배너: [${type}] ${msg}`);
        
        var warningBanner = document.querySelector("#unity-warning");
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
        }
        var div = document.createElement('div');
        div.innerHTML = msg;
        warningBanner.appendChild(div);
        if (type == 'error') div.style = 'background: red; padding: 10px;';
        else {
          if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
          setTimeout(function() {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }, 5000);
        }
        updateBannerVisibility();
      }

      // ========== Unity 빌드 설정 ==========
      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/web.loader.js";
      var config = {
        arguments: [],
        dataUrl: buildUrl + "/web.data",
        frameworkUrl: buildUrl + "/web.framework.js",
        codeUrl: buildUrl + "/web.wasm",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "PM-Studios",
        productName: "FUZE",
        productVersion: "0.1",
        devicePixelRatio: 1,
        showBanner: unityShowBanner,
      };

      // ========== 초기 Canvas 설정 ==========
      if (isCompactMode || isMobile) {
        canvas.style.width = "100%";
        canvas.style.height = "100%";
        
        debugLog('모바일/컴팩트 모드 설정');
        logCanvasState('초기 설정 (모바일)');
        
        var meta = document.createElement('meta');
        meta.name = 'viewport';
        meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
        document.getElementsByTagName('head')[0].appendChild(meta);
        document.querySelector("#unity-container").className = "unity-mobile";
        canvas.className = "unity-mobile";
      } else {
        canvas.style.width = "350px";
        canvas.style.height = "470px";
        
        debugLog('Desktop 모드 설정');
        logCanvasState('초기 설정 (Desktop)');
      }

      document.querySelector("#unity-loading-bar").style.display = "block";

      // ========== Unity 로드 ==========
      var script = document.createElement("script");
      script.src = loaderUrl;
      script.onload = () => {
        debugLog('Unity 로더 스크립트 로드됨');
        
        createUnityInstance(canvas, config, (progress) => {
          document.querySelector("#unity-progress-bar-full").style.width = 100 * progress + "%";
          if (progress === 1) {
            debugLog('Unity 로딩 100% 완료');
          }
        }).then((instance) => {
          unityInstance = instance;
          isLoaded = true;
          
          debugLog('===== Unity Instance 생성 완료 =====');
          logCanvasState('Unity 로드 후');
          
          document.querySelector("#unity-loading-bar").style.display = "none";
          
          if (!isCompactMode && !isMobile) {
            document.querySelector("#unity-fullscreen-button").onclick = () => {
              unityInstance.SetFullscreen(1);
            };
          }

          // ========== Unity 이벤트 디스패처 ==========
          window.dispatchReactUnityEvent = function(eventName, data) {
            debugLog(`Unity → JS: ${eventName} = ${data}`);
            
            if (window.flutter_inappwebview) {
              window.flutter_inappwebview.callHandler('unityEvent', {
                eventName: eventName,
                data: data
              });
            }

            switch(eventName) {
              case "OnStateChanged":
                handleStateChanged(data);
                break;
              case "OnChangedAvatar":
                handleChangedAvatar(data);
                break;
              default:
                debugLog(`알 수 없는 Unity 이벤트: ${eventName}`);
            }
          };

          // ========== Flutter → Unity 함수 ==========
          window.sendToUnity = function(gameObject, method, value) {
            debugLog(`Flutter → Unity: ${gameObject}.${method}(${value})`);
  
            if (unityInstance && isLoaded) {
              unityInstance.SendMessage(gameObject, method, value);
              return true;
            } else {
              debugLog('Unity 미로드 상태');
              return false;
            }
          };
          
          debugLog('===== Unity 초기화 완료 =====');
          
          // ========== URL User ID 자동 설정 ==========
          if (urlUserId) {
            var userId = parseInt(urlUserId);
            if (!isNaN(userId) && userId > 0) {
              debugLog(`자동 User ID 설정: ${userId}`);
              setTimeout(() => {
                unityInstance.SendMessage("System", "LoadMineAvatar_ForDev", userId);
              }, 500);
            }
          }
          
        }).catch((message) => {
          debugLog(`Unity 로드 실패: ${message}`);
          alert(message);
        });
      };

      document.body.appendChild(script);
      
      debugLog('===== 초기화 시작 =====');
      debugLog(`User Agent: ${navigator.userAgent}`);
      debugLog(`Screen: ${screen.width}x${screen.height}`);
      debugLog(`Window: ${window.innerWidth}x${window.innerHeight}`);
    </script>
  </body>
</html>
